#!/usr/bin/env python3
import boto3

# ================= CONFIG =================
REGION = "us-east-1"

PROJECT = "cpu-stress"
ENV = "dev"

AMI_ID = "ami-00db578e5e88fdf63"     # <<< PUT YOUR AMI HERE
INSTANCE_TYPE = "t3.medium"

VPC_CIDR = "10.0.0.0/16"
SUBNET_CIDR = "10.0.1.0/24"

ASG_MIN = 2
ASG_DESIRED = 2
ASG_MAX = 6

CPU_TARGET = 50  # %

# =========================================

ec2 = boto3.client("ec2", region_name=REGION)
elbv2 = boto3.client("elbv2", region_name=REGION)
asg = boto3.client("autoscaling", region_name=REGION)

TAGS = [
    {"Key": "Project", "Value": PROJECT},
    {"Key": "Env", "Value": ENV},
]


def get_single_az():
    return ec2.describe_availability_zones()["AvailabilityZones"][0]["ZoneName"]


def create_vpc():
    vpc = ec2.create_vpc(CidrBlock=VPC_CIDR)["Vpc"]
    vpc_id = vpc["VpcId"]

    ec2.modify_vpc_attribute(VpcId=vpc_id, EnableDnsSupport={"Value": True})
    ec2.modify_vpc_attribute(VpcId=vpc_id, EnableDnsHostnames={"Value": True})
    ec2.create_tags(Resources=[vpc_id], Tags=TAGS)

    print("[+] VPC:", vpc_id)
    return vpc_id


def create_subnet(vpc_id):
    az = get_single_az()
    subnet = ec2.create_subnet(
        VpcId=vpc_id,
        CidrBlock=SUBNET_CIDR,
        AvailabilityZone=az
    )["Subnet"]

    subnet_id = subnet["SubnetId"]

    ec2.modify_subnet_attribute(
        SubnetId=subnet_id,
        MapPublicIpOnLaunch={"Value": True}
    )
    ec2.create_tags(Resources=[subnet_id], Tags=TAGS)

    print("[+] Subnet:", subnet_id, az)
    return subnet_id


def create_igw_and_route(vpc_id, subnet_id):
    igw = ec2.create_internet_gateway()["InternetGateway"]
    igw_id = igw["InternetGatewayId"]

    ec2.attach_internet_gateway(InternetGatewayId=igw_id, VpcId=vpc_id)

    rt = ec2.create_route_table(VpcId=vpc_id)["RouteTable"]
    rt_id = rt["RouteTableId"]

    ec2.create_route(
        RouteTableId=rt_id,
        DestinationCidrBlock="0.0.0.0/0",
        GatewayId=igw_id
    )

    ec2.associate_route_table(RouteTableId=rt_id, SubnetId=subnet_id)

    print("[+] IGW + Route Table")
    return igw_id, rt_id


def create_security_group(vpc_id):
    sg = ec2.create_security_group(
        GroupName=f"{PROJECT}-sg",
        Description="CPU Stress SG",
        VpcId=vpc_id
    )
    sg_id = sg["GroupId"]

    # Open HTTP to the world (Internet -> NLB -> EC2)
    ec2.authorize_security_group_ingress(
        GroupId=sg_id,
        IpPermissions=[
            {
                "IpProtocol": "tcp",
                "FromPort": 80,
                "ToPort": 80,
                "IpRanges": [{"CidrIp": "0.0.0.0/0"}],
            }
        ],
    )

    ec2.create_tags(Resources=[sg_id], Tags=TAGS)

    print("[+] Security Group (HTTP open):", sg_id)
    return sg_id


def create_launch_template(sg_id):
    lt_name = f"{PROJECT}-lt"

    lt = ec2.create_launch_template(
        LaunchTemplateName=lt_name,
        LaunchTemplateData={
            "ImageId": AMI_ID,
            "InstanceType": INSTANCE_TYPE,
            "SecurityGroupIds": [sg_id],
        },
        TagSpecifications=[
            {
                "ResourceType": "launch-template",
                "Tags": TAGS,
            }
        ],
    )

    lt_id = lt["LaunchTemplate"]["LaunchTemplateId"]
    print("[+] Launch Template:", lt_id)
    return lt_id


def create_target_group(vpc_id):
    tg = elbv2.create_target_group(
        Name=f"{PROJECT}-tg",
        Protocol="TCP",
        Port=80,
        VpcId=vpc_id,
        HealthCheckProtocol="HTTP",
        HealthCheckPath="/health",
        TargetType="instance"
    )

    tg_arn = tg["TargetGroups"][0]["TargetGroupArn"]
    print("[+] Target Group:", tg_arn)
    return tg_arn


def create_nlb(subnet_id, tg_arn):
    lb = elbv2.create_load_balancer(
        Name=f"{PROJECT}-nlb",
        Type="network",
        Scheme="internet-facing",
        Subnets=[subnet_id],
        Tags=TAGS
    )

    lb_arn = lb["LoadBalancers"][0]["LoadBalancerArn"]
    dns = lb["LoadBalancers"][0]["DNSName"]

    elbv2.create_listener(
        LoadBalancerArn=lb_arn,
        Protocol="TCP",
        Port=80,
        DefaultActions=[{"Type": "forward", "TargetGroupArn": tg_arn}],
    )

    print("[+] NLB:", dns)
    return lb_arn, dns


def create_asg(subnet_id, lt_id, tg_arn):
    asg_name = f"{PROJECT}-asg"

    asg.create_auto_scaling_group(
        AutoScalingGroupName=asg_name,
        LaunchTemplate={
            "LaunchTemplateId": lt_id,
            "Version": "$Latest",
        },
        MinSize=ASG_MIN,
        MaxSize=ASG_MAX,
        DesiredCapacity=ASG_DESIRED,
        VPCZoneIdentifier=subnet_id,
        TargetGroupARNs=[tg_arn],
        Tags=[
            {
                "Key": "Name",
                "Value": PROJECT,
                "PropagateAtLaunch": True,
            }
        ],
    )

    asg.put_scaling_policy(
        AutoScalingGroupName=asg_name,
        PolicyName="cpu-target",
        PolicyType="TargetTrackingScaling",
        TargetTrackingConfiguration={
            "PredefinedMetricSpecification": {
                "PredefinedMetricType": "ASGAverageCPUUtilization"
            },
            "TargetValue": CPU_TARGET,
        },
    )

    print("[+] Auto Scaling Group:", asg_name)


def main():
    vpc_id = create_vpc()
    subnet_id = create_subnet(vpc_id)
    create_igw_and_route(vpc_id, subnet_id)
    sg_id = create_security_group(vpc_id)
    lt_id = create_launch_template(sg_id)
    tg_arn = create_target_group(vpc_id)
    _, dns = create_nlb(subnet_id, tg_arn)
    create_asg(subnet_id, lt_id, tg_arn)

    print("\nDONE")
    print("Open:", f"http://{dns}")


if __name__ == "__main__":
    main()
